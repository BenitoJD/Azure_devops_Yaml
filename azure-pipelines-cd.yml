trigger: none
pr: none

parameters:
- name: targetEnvironment
  displayName: Target SIT deployment
  type: string
  default: SIT_IT1_ADR
  values:
  - SIT_IT1_ADR
  - SIT_IT2_ADR
  - SIT_IT3_ADR
  - SIT_IT4_ADR
- name: buildPipelineSource
  displayName: Build pipeline to consume
  type: string
  default: MDVersionUpgrade/Lonestar

resources:
  pipelines:
  - pipeline: autoDataRefreshBuild
    source: ${{ parameters.buildPipelineSource }}
    trigger: none

variables:
- name: artifactName
  value: 'AutoDataRefresh'
- name: artifactZip
  value: 'Boots.MasterData.Application.AutoDataRefresh.zip'
- name: extractedFolder
  value: '$(Pipeline.Workspace)\AutoDataRefreshExtracted'
- ${{ if eq(parameters.targetEnvironment, 'SIT_IT1_ADR') }}:
  - group: SIT_IT1_ADR
- ${{ if eq(parameters.targetEnvironment, 'SIT_IT2_ADR') }}:
  - group: SIT_IT2_ADR
- ${{ if eq(parameters.targetEnvironment, 'SIT_IT3_ADR') }}:
  - group: SIT_IT3_ADR
- ${{ if eq(parameters.targetEnvironment, 'SIT_IT4_ADR') }}:
  - group: SIT_IT4_ADR

stages:
- stage: Deploy_AutoDataRefresh
  displayName: Deploy ${{ parameters.targetEnvironment }}
  jobs:
  - job: Deploy
    displayName: Build and deploy ${{ parameters.targetEnvironment }}
    pool:
      name: ccoe-nprod-windows-mdp-01
    steps:
    - download: autoDataRefreshBuild
      displayName: Download AutoDataRefresh artifact
      artifact: $(artifactName)

    - task: ExtractFiles@1
      displayName: Extract AutoDataRefresh package
      inputs:
        archiveFilePatterns: '$(Pipeline.Workspace)/autoDataRefreshBuild/$(artifactName)/$(artifactZip)'
        destinationFolder: '$(extractedFolder)'
        cleanDestinationFolder: true

    - task: FileTransform@2
      displayName: Apply configuration transform
      inputs:
        folderPath: '$(extractedFolder)'
        fileType: xml
        targetFiles: '**/Boots.MasterData.Application.AutoDataRefresh.exe.config'
        enableXmlTransform: false
        enableXmlVariableSubstitution: true

    - task: PowerShell@2
      displayName: Deploy AutoDataRefresh to G drive
      inputs:
        targetType: inline
        script: |
          $source = "$(extractedFolder)"
          $destination = "G:\MasterData\AutoDataRefresh"
          Write-Host "Source: $source"
          Write-Host "Destination: $destination"

          if (-not (Test-Path -Path $source)) {
              throw "Extracted files not found at $source"
          }

          if (Test-Path -Path $destination) {
              Write-Host "Clearing existing contents at $destination"
              Get-ChildItem -Path $destination -Force | Remove-Item -Recurse -Force -ErrorAction Stop
          } else {
              Write-Host "Creating destination path $destination"
              New-Item -ItemType Directory -Path $destination -Force | Out-Null
          }

          Write-Host "Copying files..."
          Copy-Item -Path (Join-Path $source '*') -Destination $destination -Recurse -Force
          Write-Host "Deployment completed for ${{ parameters.targetEnvironment }}"

