trigger: none
pr: none

parameters:
- name: configVariableGroup
  displayName: SIT variable group (values injected into config)
  type: string
  default: SIT_IT1_ADR
  values:
  - SIT_IT1_ADR
  - SIT_IT2_ADR
  - SIT_IT3_ADR
  - SIT_IT4_ADR

- name: buildPipelineName
  displayName: Build pipeline (definition name)
  type: string
  default: MasterData.AutoDataRefresh

variables:
- name: artifactName
  value: 'AutoDataRefresh'
- name: artifactZip
  value: 'Boots.MasterData.Application.AutoDataRefresh.zip'
- name: extractedFolder
  value: '$(Pipeline.Workspace)\AutoDataRefreshExtracted'
- name: downloadedArtifactFolder
  value: '$(Pipeline.Workspace)\AutoDataRefreshDownloaded'
- name: selectedBuildPipelineName
  value: ${{ parameters.buildPipelineName }}
- ${{ if eq(parameters.configVariableGroup, 'SIT_IT1_ADR') }}:
  - group: SIT_IT1_ADR
  - name: deployPath
    value: 'G:\MasterData\AutoDataRefresh\IT1_SIT_ADR'
- ${{ if eq(parameters.configVariableGroup, 'SIT_IT2_ADR') }}:
  - group: SIT_IT2_ADR
  - name: deployPath
    value: 'G:\MasterData\AutoDataRefresh\IT2_SIT_ADR'
- ${{ if eq(parameters.configVariableGroup, 'SIT_IT3_ADR') }}:
  - group: SIT_IT3_ADR
  - name: deployPath
    value: 'G:\MasterData\AutoDataRefresh\IT3_SIT_ADR'
- ${{ if eq(parameters.configVariableGroup, 'SIT_IT4_ADR') }}:
  - group: SIT_IT4_ADR
  - name: deployPath
    value: 'G:\MasterData\AutoDataRefresh\IT4_SIT_ADR'

stages:
- stage: Deploy_AutoDataRefresh
  displayName: Deploy SIT using ${{ parameters.configVariableGroup }}
  jobs:
  - deployment: Deploy
    displayName: Deploy with ${{ parameters.configVariableGroup }}
    environment: SIT
    strategy:
      runOnce:
        deploy:
          steps:
          - task: DownloadPipelineArtifact@2
            inputs:
              buildType: specific
              project: $(System.TeamProject)
              definition: $(selectedBuildPipelineName)
              buildVersionToDownload: latest
              artifactName: $(artifactName)
              targetPath: '$(downloadedArtifactFolder)'

          - task: ExtractFiles@1
            inputs:
              archiveFilePatterns: '$(downloadedArtifactFolder)/$(artifactZip)'
              destinationFolder: '$(extractedFolder)'
              cleanDestinationFolder: true

          - task: PowerShell@2
            displayName: Locate config file
            inputs:
              targetType: inline
              script: |
                $ErrorActionPreference = 'Stop'
                $config = Get-ChildItem -Path "$(extractedFolder)" -Filter "Boots.MasterData.Application.AutoDataRefresh.exe.config" -Recurse -File | Select-Object -First 1
                if (-not $config) { throw "Config file not found" }
                Write-Host "##vso[task.setvariable variable=configFolder]$(Split-Path $config.FullName -Parent)"
                Write-Host "##vso[task.setvariable variable=configFileName]$(Split-Path $config.FullName -Leaf)"

          - task: FileTransform@2
            displayName: Apply configuration transform
            inputs:
              folderPath: '$(configFolder)'
              fileType: xml
              targetFiles: '$(configFileName)'
              enableXmlVariableSubstitution: true

          - task: PowerShell@2
            displayName: Deploy to SIT
            inputs:
              targetType: inline
              script: |
                $ErrorActionPreference = 'Stop'
                $source = "$(extractedFolder)"
                $destination = "$(deployPath)"
                if (-not (Test-Path $source)) { throw "Source not found: $source" }
                if (Test-Path $destination) { Get-ChildItem $destination -Force | Remove-Item -Recurse -Force }
                else { New-Item -ItemType Directory -Path $destination -Force | Out-Null }
                Copy-Item -Path (Join-Path $source '*') -Destination $destination -Recurse -Force
