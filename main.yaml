pool:
  name: ccoe-nprod-windows-mdp-01

trigger:
- none

name: $(SourceBranchName)_$(Date:yyyyMMdd)$(Rev:.r)

parameters:
  - name: webSlot
    displayName: 'Web Environment / Slot'
    type: string
    default: Dev
    values:
      - Dev
      - FT1
      - FT2
      - FT3
      - QA
      - Demo
      - SIT
      - Pre-Prod
      - Prod
      - R1

variables:
  - name: BuildNumber
    value: '$(Build.BuildNumber)'
  - name: BranchName
    value: '$(Build.SourceBranchName)'
  - name: BuildVersion
    value: '$(Build.BuildId)'

  # Server catalog and paths
  - group: vg-shared-servers
  - group: vg-shared-paths
  - group: vg-shared-Main-IIS-Config

  # WinRM service account (non-prod vs prod) based on webSlot
  - ${{ if ne(parameters.webSlot, 'Prod') }}:
      - group: NonProd-WinRM-ServiceAccount
  - ${{ if eq(parameters.webSlot, 'Prod') }}:
      - group: Prod-WinRM-ServiceAccount

  # Web configuration variable groups (per slot)
  - ${{ if eq(parameters.webSlot, 'Dev') }}:
      - group: Development_Web
  - ${{ if eq(parameters.webSlot, 'FT1') }}:
      - group: FT1_Web
  - ${{ if eq(parameters.webSlot, 'FT2') }}:
      - group: FT2_Web
  - ${{ if eq(parameters.webSlot, 'FT3') }}:
      - group: FT3_Web
  - ${{ if eq(parameters.webSlot, 'QA') }}:
      - group: QA_Web
  - ${{ if eq(parameters.webSlot, 'Demo') }}:
      - group: Demo_Web
  - ${{ if eq(parameters.webSlot, 'SIT') }}:
      - group: SIT_Web
  - ${{ if eq(parameters.webSlot, 'Pre-Prod') }}:
      - group: Pre-Prod_Web
  - ${{ if eq(parameters.webSlot, 'Prod') }}:
      - group: Production_Web
  - ${{ if eq(parameters.webSlot, 'R1') }}:
      - group: R1_Web

  # Server selection per webSlot (from vg-shared-servers)
  - ${{ if eq(parameters.webSlot, 'Dev') }}:
      - name: selectedWebServers
        value: '$(Development-web-server)'
  - ${{ if eq(parameters.webSlot, 'FT1') }}:
      - name: selectedWebServers
        value: '$(Development-web-server)'
  - ${{ if eq(parameters.webSlot, 'FT2') }}:
      - name: selectedWebServers
        value: '$(Development-web-server)'
  - ${{ if eq(parameters.webSlot, 'FT3') }}:
      - name: selectedWebServers
        value: '$(Development-web-server)'
  - ${{ if eq(parameters.webSlot, 'QA') }}:
      - name: selectedWebServers
        value: '$(Development-web-server)'
  - ${{ if eq(parameters.webSlot, 'Demo') }}:
      - name: selectedWebServers
        value: '$(Development-web-server)'
  - ${{ if eq(parameters.webSlot, 'R1') }}:
      - name: selectedWebServers
        value: '$(Development-web-server)'
  - ${{ if eq(parameters.webSlot, 'SIT') }}:
      - name: selectedWebServers
        value: '$(SIT-web-server)'
  - ${{ if eq(parameters.webSlot, 'Pre-Prod') }}:
      - name: selectedWebServers
        value: '$(Pre-prod-web1-server),$(Pre-prod-web2-server)'
  - ${{ if eq(parameters.webSlot, 'Prod') }}:
      - name: selectedWebServers
        value: '$(Production-web1-Server),$(Production-web2-Server)'

resources:
  pipelines:
   - pipeline: 'MasterData.Main'
     project: 'MasterData'
     source: 'MasterData.Main'
     branch: 'MDVersionUpgrade/Lonestar'

stages:
  - stage: Initialize
    displayName: 'Initialize and Select Targets'
    jobs:
      - job: Initialize_Env
        displayName: 'Initialize'
        steps:
          - checkout: none
          - task: PowerShell@2
            displayName: 'Build Information'
            inputs:
              targetType: 'inline'
              script: |
                Write-Host "Branch: $(BranchName)"
                Write-Host "Build: $(BuildNumber)"
                Write-Host "Version: $(BuildVersion)"
                Write-Host "Web Slot: $(webSlot)"
                Write-Host "Target Servers: $(selectedWebServers)"

  - stage: AcquireArtifacts
    displayName: 'Acquire Artifacts'
    dependsOn: Initialize
    condition: succeeded()
    jobs:
      - job: Acquire
        displayName: 'Download and Prepare Artifacts'
        steps:
          - download: 'MasterData.Main'
            displayName: 'Download artifacts'
            artifact: 'drop'
          - task: ExtractFiles@1
            displayName: 'Extract artifacts'
            inputs:
              archiveFilePatterns: '$(Pipeline.Workspace)/MasterData.Main/drop/*.zip'
              destinationFolder: '$(Pipeline.Workspace)/temp_managed'
              cleanDestinationFolder: true
              overwriteExistingFiles: true

  - stage: InjectConfiguration
    displayName: 'Inject Configuration'
    dependsOn: AcquireArtifacts
    condition: succeeded()
    jobs:
      - job: Transform_Config
        displayName: 'Transform web.config'
        steps:
          - task: FileTransform@1
            displayName: 'Transform configuration files for $(webSlot)'
            inputs:
              folderPath: '$(Pipeline.Workspace)/temp_managed'
              fileType: "xml"
              targetFiles: "**/web.config"
          - task: ArchiveFiles@2
            displayName: 'Re-zip transformed artifact'
            inputs:
              rootFolderOrFile: '$(Pipeline.Workspace)/temp_managed'
              includeRootFolder: false
              archiveType: "zip"
              archiveFile: '$(Pipeline.Workspace)/MasterData.Main/drop/transformed.zip'
              replaceExistingArchive: true

  - stage: Backup
    displayName: 'Backup Current Deployments'
    dependsOn: InjectConfiguration
    condition: succeeded()
    jobs:
      - job: Backup_Site
        displayName: 'Backup current deployment'
        steps:
          - task: PowerShellOnTargetMachines@3
            displayName: 'Backup active content'
            inputs:
              Machines: "$(selectedWebServers)"
              UserName: "$(winrmUserName)"
              UserPassword: "$(winrmPassword)"
              InlineScript: |
                $webSlot = "$(webSlot)"
                $buildNumber = "$(BuildNumber)"
                $branchName = "$(BranchName)"
                $timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
                
                # Determine prefix for IIS config variables
                $prefix = switch ($webSlot) {
                  "Dev" { "Dev_" }
                  "FT1" { "FT1_" }
                  "FT2" { "FT2_" }
                  "FT3" { "FT3_" }
                  "QA" { "QA_" }
                  "Demo" { "Demo_" }
                  "SIT" { "SIT_" }
                  "Pre-Prod" { "Pre-Prod_" }
                  "Prod" { "Prod_" }
                  "R1" { "R1_" }
                  default { "Dev_" }
                }
                
                # Get physical path (prefer IIS config override, fallback to Web_Deployment_Path + slot)
                $webDeploymentPath = "$(Web_Deployment_Path)"
                $iisPathVar = "${prefix}Server_Website_Path"
                $iisPathValue = (Get-Item "Env:$iisPathVar" -ErrorAction SilentlyContinue).Value
                
                if ($iisPathValue -and $iisPathValue.Trim() -ne "") {
                  $destinationPath = $iisPathValue
                } else {
                  $destinationPath = Join-Path $webDeploymentPath $webSlot
                }
                
                $backupBasePath = "$(Web_Deployment_Path)\Backups"
                if (-not (Test-Path $backupBasePath)) {
                  New-Item -ItemType Directory -Path $backupBasePath -Force | Out-Null
                }
                
                $backupPath = Join-Path $backupBasePath "${webSlot}_${branchName}_${buildNumber}_${timestamp}"
                
                if (Test-Path $destinationPath) {
                  Write-Host "Backing up $destinationPath to $backupPath"
                  New-Item -ItemType Directory -Path $backupPath -Force | Out-Null
                  Copy-Item -Path "$destinationPath\*" -Destination $backupPath -Recurse -Force
                  Write-Host "Backup completed successfully"
                } else {
                  Write-Host "No existing deployment found at $destinationPath, skipping backup"
                }
              NewPsSessionOptionArguments: >
                -SkipCACheck
                -SkipCNCheck
                -SkipRevocationCheck
                -IdleTimeout 7200000
                -OperationTimeout 0
                -OutputBufferingMode Block

  - stage: DeployFiles
    displayName: 'Deploy Files'
    dependsOn: Backup
    condition: succeeded()
    jobs:
      - job: Deploy_Content
        displayName: 'Copy and extract application files'
        steps:
          - task: WindowsMachineFileCopy@2
            displayName: 'Copy artifact zip to $(selectedWebServers)'
            inputs:
              SourcePath: '$(Pipeline.Workspace)/MasterData.Main/drop/transformed.zip'
              MachineNames: "$(selectedWebServers)"
              AdminUserName: "$(winrmUserName)"
              AdminPassword: "$(winrmPassword)"
              TargetPath: 'C:\Temp\WebDeploy'
              Protocol: "WinRM"
          - task: PowerShellOnTargetMachines@3
            displayName: 'Extract files on target servers'
            inputs:
              Machines: "$(selectedWebServers)"
              UserName: "$(winrmUserName)"
              UserPassword: "$(winrmPassword)"
              InlineScript: |
                $webSlot = "$(webSlot)"
                
                # Determine prefix for IIS config variables
                $prefix = switch ($webSlot) {
                  "Dev" { "Dev_" }
                  "FT1" { "FT1_" }
                  "FT2" { "FT2_" }
                  "FT3" { "FT3_" }
                  "QA" { "QA_" }
                  "Demo" { "Demo_" }
                  "SIT" { "SIT_" }
                  "Pre-Prod" { "Pre-Prod_" }
                  "Prod" { "Prod_" }
                  "R1" { "R1_" }
                  default { "Dev_" }
                }
                
                # Get physical path (prefer IIS config override, fallback to Web_Deployment_Path + slot)
                $webDeploymentPath = "$(Web_Deployment_Path)"
                $iisPathVar = "${prefix}Server_Website_Path"
                $iisPathValue = (Get-Item "Env:$iisPathVar" -ErrorAction SilentlyContinue).Value
                
                if ($iisPathValue -and $iisPathValue.Trim() -ne "") {
                  $destinationPath = $iisPathValue
                } else {
                  $destinationPath = Join-Path $webDeploymentPath $webSlot
                }
                
                $tempFolder = 'C:\Temp\WebDeploy'
                $zipPath = Join-Path $tempFolder 'transformed.zip'
                
                Write-Host "Checking for zip file at: $zipPath"
                if (-not (Test-Path $zipPath)) {
                  Write-Host "ERROR: Zip file not found at $zipPath"
                  if (Test-Path $tempFolder) {
                    Write-Host "Temp folder contents:"
                    Get-ChildItem -Path $tempFolder -Recurse | ForEach-Object { Write-Host "  - $($_.FullName)" }
                  }
                  throw "Artifact zip not found at $zipPath"
                }
                Write-Host "Zip file found successfully at $zipPath"
                
                if (-not (Test-Path $destinationPath)) {
                  Write-Host "Creating destination folder $destinationPath"
                  New-Item -ItemType Directory -Path $destinationPath -Force | Out-Null
                } else {
                  Write-Host "Clearing existing contents in $destinationPath"
                  Get-ChildItem -Path $destinationPath -Exclude "App_Data" -Recurse -Force | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
                }
                
                Write-Host "Extracting $zipPath to $destinationPath"
                Expand-Archive -LiteralPath $zipPath -DestinationPath $destinationPath -Force
                Write-Host "Extraction completed successfully"
              NewPsSessionOptionArguments: >
                -SkipCACheck
                -SkipCNCheck
                -SkipRevocationCheck
                -IdleTimeout 7200000
                -OperationTimeout 0
                -OutputBufferingMode Block

  - stage: ConfigureIIS
    displayName: 'Configure IIS'
    dependsOn: DeployFiles
    condition: succeeded()
    jobs:
      - job: Configure_IIS
        displayName: 'Ensure site and app pool'
        steps:
          - task: PowerShellOnTargetMachines@3
            displayName: 'Ensure IIS configuration'
            inputs:
              Machines: "$(selectedWebServers)"
              UserName: "$(winrmUserName)"
              UserPassword: "$(winrmPassword)"
              InlineScript: |
                $webSlot = "$(webSlot)"
                
                # Determine prefix for IIS config variables
                $prefix = switch ($webSlot) {
                  "Dev" { "Dev_" }
                  "FT1" { "FT1_" }
                  "FT2" { "FT2_" }
                  "FT3" { "FT3_" }
                  "QA" { "QA_" }
                  "Demo" { "Demo_" }
                  "SIT" { "SIT_" }
                  "Pre-Prod" { "Pre-Prod_" }
                  "Prod" { "Prod_" }
                  "R1" { "R1_" }
                  default { "Dev_" }
                }
                
                # Special handling for Prod app pool name (Prodcuction typo)
                $appPoolVar = if ($webSlot -eq "Prod") { "Prodcuction_Server_AppPool_Name" } else { "${prefix}Server_AppPool_Name" }
                $portVar = "${prefix}Server_IIS_Port"
                $pathVar = if ($webSlot -eq "SIT") { "SIT_DServer_Website_Path" } else { "${prefix}Server_Website_Path" }
                
                $appPoolName = (Get-Item "Env:$appPoolVar" -ErrorAction SilentlyContinue).Value
                $port = (Get-Item "Env:$portVar" -ErrorAction SilentlyContinue).Value
                $physicalPath = (Get-Item "Env:$pathVar" -ErrorAction SilentlyContinue).Value
                
                # Fallback to Web_Deployment_Path + slot if path not in IIS config
                if (-not $physicalPath -or $physicalPath.Trim() -eq "") {
                  $webDeploymentPath = "$(Web_Deployment_Path)"
                  $physicalPath = Join-Path $webDeploymentPath $webSlot
                }
                
                if (-not $appPoolName -or -not $port) {
                  throw "Required IIS configuration variables not found: AppPool=$appPoolName, Port=$port"
                }
                
                Write-Host "Configuring IIS: AppPool=$appPoolName, Port=$port, Path=$physicalPath"
                
                # Site name convention
                $siteName = "MasterData-Web-$webSlot"
                
                $useAppCmd = $false
                try { 
                  Import-Module WebAdministration -ErrorAction Stop 
                } catch { 
                  $useAppCmd = $true 
                }
                
                if ($useAppCmd) {
                  # Use appcmd.exe
                  try { 
                    & "C:\Windows\System32\inetsrv\appcmd.exe" add apppool /name:$appPoolName /managedRuntimeVersion:v4.0 /managedPipelineMode:Integrated 
                  } catch {}
                  
                  try {
                    & "C:\Windows\System32\inetsrv\appcmd.exe" add site /name:$siteName /physicalPath:$physicalPath /bindings:http/*:$port:
                    & "C:\Windows\System32\inetsrv\appcmd.exe" set app "$siteName/" /applicationPool:$appPoolName
                  } catch {}
                } else {
                  # Use WebAdministration module
                  if (-not (Test-Path "IIS:\AppPools\$appPoolName")) { 
                    New-WebAppPool -Name $appPoolName | Out-Null 
                  }
                  Set-ItemProperty "IIS:\AppPools\$appPoolName" -Name managedRuntimeVersion -Value "v4.0"
                  Set-ItemProperty "IIS:\AppPools\$appPoolName" -Name managedPipelineMode -Value "Integrated"
                  
                  $site = Get-Website -Name $siteName -ErrorAction SilentlyContinue
                  if ($site) {
                    Set-ItemProperty "IIS:\Sites\$siteName" -Name applicationPool -Value $appPoolName
                    Set-ItemProperty "IIS:\Sites\$siteName" -Name physicalPath -Value $physicalPath
                    $desired = "*:$port:"
                    $httpBindings = Get-WebBinding -Name $siteName -Protocol "http" -ErrorAction SilentlyContinue
                    $matching = @()
                    if ($httpBindings) { 
                      $matching = $httpBindings | Where-Object { $_.bindingInformation -eq $desired } 
                    }
                    if (-not $matching -or $matching.Count -eq 0) { 
                      New-WebBinding -Name $siteName -Protocol "http" -Port $port -IPAddress "*" -HostHeader "" 
                    }
                  } else {
                    New-Website -Name $siteName -PhysicalPath $physicalPath -ApplicationPool $appPoolName -Port $port | Out-Null
                  }
                }
                
                Write-Host "IIS configuration completed successfully"
              NewPsSessionOptionArguments: >
                -SkipCACheck
                -SkipCNCheck
                -SkipRevocationCheck
                -IdleTimeout 7200000
                -OperationTimeout 0
                -OutputBufferingMode Block

  - stage: Permissions
    displayName: 'Set Permissions'
    dependsOn: ConfigureIIS
    condition: succeeded()
    jobs:
      - job: Set_ACLs
        displayName: 'Grant IIS permissions'
        steps:
          - task: PowerShellOnTargetMachines@3
            displayName: 'Set folder ACLs'
            inputs:
              Machines: "$(selectedWebServers)"
              UserName: "$(winrmUserName)"
              UserPassword: "$(winrmPassword)"
              InlineScript: |
                $webSlot = "$(webSlot)"
                
                # Determine prefix for IIS config variables
                $prefix = switch ($webSlot) {
                  "Dev" { "Dev_" }
                  "FT1" { "FT1_" }
                  "FT2" { "FT2_" }
                  "FT3" { "FT3_" }
                  "QA" { "QA_" }
                  "Demo" { "Demo_" }
                  "SIT" { "SIT_" }
                  "Pre-Prod" { "Pre-Prod_" }
                  "Prod" { "Prod_" }
                  "R1" { "R1_" }
                  default { "Dev_" }
                }
                
                # Get physical path (prefer IIS config override, fallback to Web_Deployment_Path + slot)
                $webDeploymentPath = "$(Web_Deployment_Path)"
                $pathVar = if ($webSlot -eq "SIT") { "SIT_DServer_Website_Path" } else { "${prefix}Server_Website_Path" }
                $physicalPath = (Get-Item "Env:$pathVar" -ErrorAction SilentlyContinue).Value
                
                if (-not $physicalPath -or $physicalPath.Trim() -eq "") {
                  $physicalPath = Join-Path $webDeploymentPath $webSlot
                }
                
                Write-Host "Setting permissions on $physicalPath"
                $acl = Get-Acl $physicalPath
                $rule = New-Object System.Security.AccessControl.FileSystemAccessRule("IIS_IUSRS","FullControl","ContainerInherit,ObjectInherit","None","Allow")
                $acl.SetAccessRule($rule)
                Set-Acl $physicalPath $acl
                Write-Host "Permissions set successfully"
              NewPsSessionOptionArguments: >
                -SkipCACheck
                -SkipCNCheck
                -SkipRevocationCheck
                -IdleTimeout 7200000
                -OperationTimeout 0
                -OutputBufferingMode Block

  - stage: RestartServices
    displayName: 'Restart Websites'
    dependsOn: Permissions
    condition: succeeded()
    jobs:
      - job: Stop_Sites
        displayName: 'Stop site and app pool'
        steps:
          - task: PowerShellOnTargetMachines@3
            displayName: 'Stop website'
            inputs:
              Machines: "$(selectedWebServers)"
              UserName: "$(winrmUserName)"
              UserPassword: "$(winrmPassword)"
              InlineScript: |
                $webSlot = "$(webSlot)"
                
                # Determine prefix for IIS config variables
                $prefix = switch ($webSlot) {
                  "Dev" { "Dev_" }
                  "FT1" { "FT1_" }
                  "FT2" { "FT2_" }
                  "FT3" { "FT3_" }
                  "QA" { "QA_" }
                  "Demo" { "Demo_" }
                  "SIT" { "SIT_" }
                  "Pre-Prod" { "Pre-Prod_" }
                  "Prod" { "Prod_" }
                  "R1" { "R1_" }
                  default { "Dev_" }
                }
                
                # Special handling for Prod app pool name (Prodcuction typo)
                $appPoolVar = if ($webSlot -eq "Prod") { "Prodcuction_Server_AppPool_Name" } else { "${prefix}Server_AppPool_Name" }
                $appPoolName = (Get-Item "Env:$appPoolVar" -ErrorAction SilentlyContinue).Value
                $siteName = "MasterData-Web-$webSlot"
                
                Write-Host "Stopping website: $siteName, AppPool: $appPoolName"
                
                $usePowerShell = $true
                try { 
                  Import-Module WebAdministration -ErrorAction Stop 
                } catch { 
                  $usePowerShell = $false 
                }
                
                if ($usePowerShell) {
                  try { Stop-Website -Name $siteName -ErrorAction Stop } catch {}
                  try { Stop-WebAppPool -Name $appPoolName -ErrorAction Stop } catch {}
                } else {
                  try { & "C:\Windows\System32\inetsrv\appcmd.exe" stop site /site.name:$siteName 2>$null } catch {}
                  try { & "C:\Windows\System32\inetsrv\appcmd.exe" stop apppool /apppool.name:$appPoolName 2>$null } catch {}
                }
                
                Write-Host "Stop completed"
              NewPsSessionOptionArguments: >
                -SkipCACheck
                -SkipCNCheck
                -SkipRevocationCheck
                -IdleTimeout 7200000
                -OperationTimeout 0
                -OutputBufferingMode Block
      - job: Start_Sites
        displayName: 'Start site and app pool'
        dependsOn: Stop_Sites
        steps:
          - task: PowerShellOnTargetMachines@3
            displayName: 'Start website'
            inputs:
              Machines: "$(selectedWebServers)"
              UserName: "$(winrmUserName)"
              UserPassword: "$(winrmPassword)"
              InlineScript: |
                $webSlot = "$(webSlot)"
                
                # Determine prefix for IIS config variables
                $prefix = switch ($webSlot) {
                  "Dev" { "Dev_" }
                  "FT1" { "FT1_" }
                  "FT2" { "FT2_" }
                  "FT3" { "FT3_" }
                  "QA" { "QA_" }
                  "Demo" { "Demo_" }
                  "SIT" { "SIT_" }
                  "Pre-Prod" { "Pre-Prod_" }
                  "Prod" { "Prod_" }
                  "R1" { "R1_" }
                  default { "Dev_" }
                }
                
                # Special handling for Prod app pool name (Prodcuction typo)
                $appPoolVar = if ($webSlot -eq "Prod") { "Prodcuction_Server_AppPool_Name" } else { "${prefix}Server_AppPool_Name" }
                $appPoolName = (Get-Item "Env:$appPoolVar" -ErrorAction SilentlyContinue).Value
                $siteName = "MasterData-Web-$webSlot"
                
                Write-Host "Starting website: $siteName, AppPool: $appPoolName"
                
                $usePowerShell = $true
                try { 
                  Import-Module WebAdministration -ErrorAction Stop 
                } catch { 
                  $usePowerShell = $false 
                }
                
                if ($usePowerShell) {
                  try { 
                    if ((Get-WebAppPoolState -Name $appPoolName -ErrorAction SilentlyContinue).Value -ne 'Started') { 
                      Start-WebAppPool -Name $appPoolName -ErrorAction Stop 
                    } 
                  } catch {}
                  $site = Get-Website -Name $siteName -ErrorAction SilentlyContinue
                  if ($site) { 
                    if ($site.state -ne 'Started') { 
                      try { Start-Website -Name $siteName -ErrorAction Stop } catch {} 
                    } 
                  }
                } else {
                  try { 
                    if ((& "C:\Windows\System32\inetsrv\appcmd.exe" list apppool "$appPoolName" /text:state 2>$null) -ne "Started") { 
                      & "C:\Windows\System32\inetsrv\appcmd.exe" start apppool /apppool.name:$appPoolName 2>$null 
                    } 
                  } catch {}
                  try { 
                    if ((& "C:\Windows\System32\inetsrv\appcmd.exe" list site "$siteName" /text:state 2>$null) -ne "Started") { 
                      & "C:\Windows\System32\inetsrv\appcmd.exe" start site /site.name:$siteName 2>$null 
                    } 
                  } catch {}
                }
                
                Write-Host "Start completed"
              NewPsSessionOptionArguments: >
                -SkipCACheck
                -SkipCNCheck
                -SkipRevocationCheck
                -IdleTimeout 7200000
                -OperationTimeout 0
                -OutputBufferingMode Block
